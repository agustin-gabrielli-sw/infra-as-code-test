<policies>
    <inbound>
        <base />

        <!-- Initiate timer before forwarding the request to the backend-->
		<set-variable name="startTime" value="@(DateTime.UtcNow)" />
        
        <set-header name="Authorization" exists-action="override">
            <value>Bearer {{openai-key}}</value>
        </set-header>
        <set-backend-service backend-id="openai-backend" />
    </inbound>

    <backend>
        <base />
    </backend>

    <outbound>
        <base />
        
        <!-- Parse response JSON body -->
        <set-variable name="parsedBody" value="@((JObject)context.Response.Body.As<JObject>(true))" />

        <!-- Extract token metrics from parsed JSON -->
        <set-variable name="totalTokens" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["total_tokens"]) ?? 0).ToString())" />
        <set-variable name="completionTokens" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["completion_tokens"]) ?? 0).ToString())" />
        <set-variable name="promptTokens" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["prompt_tokens"]) ?? 0).ToString())" />
        
        <!-- TODO: Review how promptFormat / promptId are received -->

        <!-- TODO: Review if same as X-SAS-Message-Type -->
        <!-- <set-variable name="promptFormat" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["prompt_format"]) ?? 0).ToString())" /> -->
        <!-- TODO: Review if same as X-SAS-Message-ID -->
        <!-- <set-variable name="promptId" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["prompt_id"]) ?? 0).ToString())" /> -->
        
        <!-- TODO: Review completionsNumber parameter usage -->
        <!-- <set-variable name="completionsNumber" value="@((((int?)((JObject)context.Variables["parsedBody"])["usage"]?["completions_number"]) ?? 0).ToString())" /> -->
        
        <!-- TODO: Continue adding metrics from here. Review metric for Size of prompts from use to copilot (bytes) -->
        
        <!-- Stop the timer and calculate duration -->
        <set-variable name="endTime" value="@((DateTime.UtcNow))" />
        <set-variable name="responseTimeMs" value="@((((int)((DateTime)context.Variables["endTime"] - (DateTime)context.Variables["startTime"]).TotalMilliseconds)).ToString())" />

        <trace source="Total Tokens Trace" severity="verbose">
            <message>Total tokens</message>
            <metadata name="customerID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Customer-ID", "unknown"))" />
            <metadata name="siteNum" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Site-Num", "unknown"))" />
            <metadata name="appName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-App-Name", "unknown"))" />
            <metadata name="viyaVersion" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Viya-Version", "unknown"))" />
            <metadata name="copilotName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Copilot-Name", "unknown"))" />
            <metadata name="chatID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Chat-ID", "unknown"))" />
            <metadata name="messageID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-ID", "unknown"))" />
            <metadata name="messageType" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-Type", "unknown"))" />
            <!-- <metadata name="promptFormat" value="@((string)context.Variables.GetValueOrDefault<string>("promptFormat"))" /> -->
            <!-- <metadata name="promptID" value="@((string)context.Variables.GetValueOrDefault<string>("promptId"))" /> -->
            <!-- <metadata name="completionsNumber" value="@((string)context.Variables.GetValueOrDefault<string>("completionsNumber"))" /> -->

            <metadata name="totalTokens" value="@((string)context.Variables.GetValueOrDefault<string>("totalTokens"))" />
        </trace>

        <trace source="Completion Tokens Trace" severity="verbose">
            <message>Completion tokens</message>
            <metadata name="customerID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Customer-ID", "unknown"))" />
            <metadata name="siteNum" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Site-Num", "unknown"))" />
            <metadata name="appName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-App-Name", "unknown"))" />
            <metadata name="viyaVersion" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Viya-Version", "unknown"))" />
            <metadata name="copilotName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Copilot-Name", "unknown"))" />
            <metadata name="chatID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Chat-ID", "unknown"))" />
            <metadata name="messageID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-ID", "unknown"))" />
            <metadata name="messageType" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-Type", "unknown"))" />
            <!-- <metadata name="promptFormat" value="@((string)context.Variables.GetValueOrDefault<string>("promptFormat"))" /> -->
            <!-- <metadata name="promptID" value="@((string)context.Variables.GetValueOrDefault<string>("promptId"))" /> -->
            <!-- <metadata name="completionsNumber" value="@((string)context.Variables.GetValueOrDefault<string>("completionsNumber"))" /> -->

            <metadata name="completionTokens" value="@((string)context.Variables.GetValueOrDefault<string>("completionTokens"))" />
        </trace>

        <trace source="Prompt Tokens Trace" severity="verbose">
            <message>Prompt tokens</message>
            <metadata name="customerID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Customer-ID", "unknown"))" />
            <metadata name="siteNum" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Site-Num", "unknown"))" />
            <metadata name="appName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-App-Name", "unknown"))" />
            <metadata name="viyaVersion" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Viya-Version", "unknown"))" />
            <metadata name="copilotName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Copilot-Name", "unknown"))" />
            <metadata name="chatID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Chat-ID", "unknown"))" />
            <metadata name="messageID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-ID", "unknown"))" />
            <metadata name="messageType" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-Type", "unknown"))" />
            <!-- <metadata name="promptFormat" value="@((string)context.Variables.GetValueOrDefault<string>("promptFormat"))" /> -->
            <!-- <metadata name="promptID" value="@((string)context.Variables.GetValueOrDefault<string>("promptId"))" /> -->
            <!-- <metadata name="completionsNumber" value="@((string)context.Variables.GetValueOrDefault<string>("completionsNumber"))" /> -->

            <metadata name="promptTokens" value="@((string)context.Variables.GetValueOrDefault<string>("promptTokens"))" />
        </trace>

        <trace source="Response Time Trace" severity="verbose">
            <message>Response time</message>
            <metadata name="customerID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Customer-ID", "unknown"))" />
            <metadata name="siteNum" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Site-Num", "unknown"))" />
            <metadata name="appName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-App-Name", "unknown"))" />
            <metadata name="viyaVersion" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Viya-Version", "unknown"))" />
            <metadata name="copilotName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Copilot-Name", "unknown"))" />
            <metadata name="chatID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Chat-ID", "unknown"))" />
            <metadata name="messageID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-ID", "unknown"))" />
            <metadata name="messageType" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-Type", "unknown"))" />
            <!-- <metadata name="promptFormat" value="@((string)context.Variables.GetValueOrDefault<string>("promptFormat"))" /> -->
            <!-- <metadata name="promptID" value="@((string)context.Variables.GetValueOrDefault<string>("promptId"))" /> -->
            <!-- <metadata name="completionsNumber" value="@((string)context.Variables.GetValueOrDefault<string>("completionsNumber"))" /> -->

            <metadata name="responseTimeMs" value="@((string)context.Variables["responseTimeMs"])" />
        </trace>

        <trace source="Request Path Trace" severity="verbose">
            <message>Request path</message>
            <metadata name="customerID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Customer-ID", "unknown"))" />
            <metadata name="siteNum" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Site-Num", "unknown"))" />
            <metadata name="appName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-App-Name", "unknown"))" />
            <metadata name="viyaVersion" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Viya-Version", "unknown"))" />
            <metadata name="copilotName" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Copilot-Name", "unknown"))" />
            <metadata name="chatID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Chat-ID", "unknown"))" />
            <metadata name="messageID" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-ID", "unknown"))" />
            <metadata name="messageType" value="@((string)context.Request.Headers.GetValueOrDefault("X-SAS-Message-Type", "unknown"))" />
            <!-- <metadata name="promptFormat" value="@((string)context.Variables.GetValueOrDefault<string>("promptFormat"))" /> -->
            <!-- <metadata name="promptID" value="@((string)context.Variables.GetValueOrDefault<string>("promptId"))" /> -->
            <!-- <metadata name="completionsNumber" value="@((string)context.Variables.GetValueOrDefault<string>("completionsNumber"))" /> -->

            <metadata name="requestPath" value="@((string)context.Request.OriginalUrl.Path)" />
        </trace>
    </outbound>

    <on-error>
        <base />
    </on-error> 
</policies>